#!/usr/bin/env perl
use strict;
use warnings;
use lib 'lib';
use lib '/home/mark/src/bif/.direnv/perl5/lib/perl5/';
use DBI;
use DBIx::Model;
use GraphViz2;
use OptArgs;

arg dsn => (
    isa      => 'Str',
    comment  => 'DBI connection string',
    required => 1,
);

arg output => (
    isa      => 'Str',
    comment  => 'graphviz output filename',
    required => 1,
);

opt exclude => (
    alias   => 'e',
    isa     => 'ArrayRef',
    comment => 'table name(s) to exclude',
    default => sub { [] },
);

opt help => (
    alias   => 'h',
    isa     => 'Bool',
    comment => 'print full help message and exit',
    ishelp  => 1,
);

opt name => (
    isa     => 'Str',
    comment => 'name of the database',
);

my $opts = optargs;
$opts->{dsn} = 'dbi:SQLite:dbname=' . $opts->{dsn} if -f $opts->{dsn};
$opts->{format} = $opts->{output} =~ s/.*\.(.*)/$1/r;

my $dbh = DBI->connect( $opts->{dsn} );
my $db  = $dbh->model(
    name    => $opts->{dsn},
    exclude => $opts->{exclude},
);

sub exclude {
    my $name = shift;
    my $list = shift;
    foreach my $try (@$list) {
        return 1 if $name =~ m/$try/;
    }
    return 0;
}

print $db->as_string . "\n";

my $graph = GraphViz2->new(
    graph  => { label    => $db->name, rankdir => 'TB' },
    edge   => { color    => 'grey' },
    global => { directed => 1 },
    graph  => { rankdir  => 'TB' },
    node   => { color    => 'blue',    shape   => 'oval' },
);

$graph->run(
    format      => $opts->{format},
    output_file => $opts->{output},
);

